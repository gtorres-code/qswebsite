(function ($) {
    "use strict";

    var pluginName = "ScrollIt",
        pluginVersion = "1.0.3";

    var defaults = {
        upKey: 38,
        downKey: 40,
        easing: "linear",
        scrollTime: 600,
        activeClass: "active",
        onPageChange: null,
        topOffset: 0
    };

    $.scrollIt = function (options) {
        var settings = $.extend(defaults, options);
        var currentIndex = 0;
        var maxIndex = $("[data-scroll-index]:last").attr("data-scroll-index");

        function scrollToIndex(index) {
            if (index < 0 || index > maxIndex) return;
            var targetOffset = $("[data-scroll-index=" + index + "]").offset().top + settings.topOffset + 1;
            $("html, body").animate({ scrollTop: targetOffset, easing: settings.easing }, settings.scrollTime);
        }

        function handleClick(event) {
            var targetIndex = $(event.target).closest("[data-scroll-nav]").attr("data-scroll-nav") || 
                              $(event.target).closest("[data-scroll-goto]").attr("data-scroll-goto");
            event.preventDefault();
            scrollToIndex(parseInt(targetIndex));
        }

        function handleKeydown(event) {
            if ($("html, body").is(":animated") && (event.which === settings.upKey || event.which === settings.downKey)) {
                return false;
            }

            if (event.which === settings.upKey && currentIndex > 0) {
                scrollToIndex(parseInt(currentIndex) - 1);
                return false;
            }
            
            if (event.which === settings.downKey && currentIndex < maxIndex) {
                scrollToIndex(parseInt(currentIndex) + 1);
                return false;
            }
            
            return true;
        }

        function updateActiveSection(newIndex) {
            if (settings.onPageChange && newIndex && currentIndex !== newIndex) {
                settings.onPageChange(newIndex);
            }
            
            currentIndex = newIndex;
            $("[data-scroll-nav]").removeClass(settings.activeClass);
            $("[data-scroll-nav=" + newIndex + "]").addClass(settings.activeClass);
        }

        function handleScroll() {
            var scrollTop = $(window).scrollTop();
            var visibleSection = $("[data-scroll-index]").filter(function (index, element) {
                return scrollTop >= $(element).offset().top + settings.topOffset && 
                       scrollTop < $(element).offset().top + settings.topOffset + $(element).outerHeight();
            });
            
            var newIndex = visibleSection.first().attr("data-scroll-index");
            updateActiveSection(newIndex);
        }

        $(window).on("scroll", handleScroll).scroll();
        $(window).on("keydown", handleKeydown);
        $("body").on("click", "[data-scroll-nav], [data-scroll-goto]", handleClick);
    };

})(jQuery);
